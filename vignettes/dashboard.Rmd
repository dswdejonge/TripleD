---
title: "Database dashboard"
output: html_document
---

```{r include=FALSE}
library(TripleD)
library(ggplot2)
library(tidyverse)
```

Database summary:   
- The database contains **`r length(unique(stations$StationID))` stations ** sampled during **`r length(unique(stations$CruiseID))` cruises**.  
- The oldest sample was taken on **`r min(stations$Date)`** and the most recent sample was taken on **`r max(stations$Date)`**.  
- Total suface area of the North Sea that has been sampled with the TripleD is ADD R CODE.   
- In total there are **`r dim(species)[1]`** biological entries from **`r length(unique(species$Species_reported))` species**.  
- Nr of individuals.  
- Total biomass.  

# Map with sampled stations
Map of all the sampled stations in the database. The North-Sea is approximately bounded by the coordinates 62N to 50N, -5W to 10E.
```{r map, echo=FALSE, message=FALSE, warning=FALSE}
# NOAA bathymetry package
library(marmap)
# Geographic high-resolution outlines
library(mapdata)
# dplry package to easily search dataframes
library(dplyr)
# library with map projections
library(mapproj)

# The North-Sea is bounded by the coordinates 62N to 50N, -5W to 10E
#lats <- c(50, 62)
#lons <- c(-5, 10)
# map boundaries based on database values with a small buffer
lats <- c(min(stations$Lat_DD)-5, max(stations$Lat_DD)+5)
lons <- c(min(stations$Lon_DD)-5, max(stations$Lon_DD)+5)

# Download North-Sea Bathymetry data from NOAA
bathy <- bathymetry
#bathy <- collect_bathymetry(stations)

# Get coastal outlines
reg <- map_data("world2Hires")
reg <- reg %>%
  filter(
    long > lons[1] &
    long < lons[2] &
    lat > lats[1] &
    lat < lats[2])

# make plot
map_samples <- ggplot() +
  
  # add 20m contour
  geom_contour(data = bathy,
               aes(x = x, y = y, z = z),
               breaks = c(-20),
               size = c(0.3),
               colour = "grey") +
  
  # add 50m contour
  geom_contour(data = bathy, 
               aes(x = x, y = y, z = z),
               breaks = c(-50),
               size = c(0.3),
               colour ="grey") +
  
  # add 100m contour
  geom_contour(data = bathy, 
               aes(x = x, y = y, z = z),
               breaks = c(-100),
               size = c(0.3),
               colour = "grey") +
  
  # add coastline
  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               fill = "darkgrey", color = NA) + 
  
  # add points
  geom_point(data = stations, aes(x = Lon_DD, y = Lat_DD),
             fill = "red", colour = "black",
             size = 1, shape = 21) +
  
  # configure projection and plot domain
  coord_map(xlim = lons, ylim = lats) +
  
  # formatting
  ylab("")+xlab("")+
  theme_bw()
map_samples  
```

# Missing raw data
Not all attributes present in the database are required; some are optional thus not always filled. The following two plots show per attribute the percentage of entries in the dataframes 'stations' and 'species' that have a value (i.e. are not NA). 
```{r stations, echo=FALSE}
stations_perc_complete <- stations %>%
  sapply(., 
    function(x){sum(length(which(!is.na(x))))/dim(stations)[1]}
  ) %>%
  sort(., decreasing = T) %>%
  as.data.frame() %>%
  as_tibble(rownames = "Attribute")
colnames(stations_perc_complete)[2] <- "Percentage"

stations_perc_complete$Attribute <- factor(
  stations_perc_complete$Attribute, levels = stations_perc_complete$Attribute)

perc_complete <- ggplot(stations_perc_complete) +
  geom_col(aes(x = Attribute, y = Percentage)) +
  labs(title = "Stations", y = "% complete i.e. not NA") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  )
perc_complete
```

```{r species, echo=FALSE}
species_perc_complete <- species %>%
  sapply(., 
    function(x){sum(length(which(!is.na(x))))/dim(species)[1]}
  ) %>%
  sort(., decreasing = T) %>%
  as.data.frame() %>%
  as_tibble(rownames = "Attribute")
colnames(species_perc_complete)[2] <- "Percentage"

species_perc_complete$Attribute <- factor(
  species_perc_complete$Attribute, levels = species_perc_complete$Attribute)

perc_complete <- ggplot(species_perc_complete) +
  geom_col(aes(x = Attribute, y = Percentage)) +
  labs(title = "Species", y = "% complete i.e. not NA") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  )
perc_complete
```

# Data accuracy
To check the accuracy of raw and automatically generated data, some exploratory plots are made. These plots show the distribution of values in order to detect suspiscious values; e.g. suspiciously deep waters, or heavy animals.
## Water depth
```{r real_vs_estimated_depths, echo=FALSE}
differences <- na.omit(abs(stations_additions$Water_depth_m - stations_additions$Water_depth_m_Bathy))
avg_diff <- sum(differences) / length(differences)
plot <- ggplot(stations_additions, aes(x = Water_depth_m, y = Water_depth_m_Bathy)) +
  geom_point() +
  geom_abline() +
  annotate(
    "text", 
    x = 50, y = 175, 
    label = paste0("average difference = ", round(avg_diff, digits = 1)," m.")) +
  labs(
    title = "Difference between observed and bathymetry water depth",
    x = "Water depth measured on site (m)", 
    y = "Water depth from NOAA bathymetry resolution 1' (m)") +
  xlim(0, max(c(stations_additions$Water_depth_m, stations_additions$Water_depth_m_Bathy), na.rm = T)) +
  ylim(0, max(c(stations_additions$Water_depth_m, stations_additions$Water_depth_m_Bathy), na.rm = T)) +
  coord_fixed() +
  theme_bw()
plot
```

```{r suspicous_depths, echo=FALSE}
plot <- ggplot(stations_additions) +
  geom_histogram(aes(x = Water_depth_m_Bathy)) +
  labs(
    title = "Suspicious water depths added?", 
    x = "Water depth from NOAA bathymetry resolution 1' (m)") +
  theme_bw()
plot
```

## Track length
```{r reported_vs_estimated_track_lengths, echo=FALSE}
#differences <- na.omit(abs(stations_additions$Water_depth_m - stations_additions$Water_depth_m_Bathy))
#avg_diff <- sum(differences) / length(differences)
tidy <- stations_additions %>%
  select(StationID, Track_dist_m, Track_dist_m_BB, Track_dist_m_GPS) %>%
  gather(Track_dist_m_GPS, Track_dist_m_BB, 
         key = "Sensor", value = "Estimated_length_m")
plot <- ggplot(
  tidy, 
  aes(
    x = Track_dist_m, 
    y = Estimated_length_m, 
    colour = Sensor)) +
  geom_point() +
  geom_abline() +
  #annotate(
  #  "text", 
  #  x = 50, y = 175, 
  #  label = paste0("average difference = ", round(avg_diff, digits = 1)," m.")) +
  labs(
    title = "Difference between reported and calculated track length",
    x = "Reported track length (m)", 
    y = "Estimated track length (m)") +
  xlim(0, max(c(tidy$Track_dist_m, tidy$Estimated_length_m), na.rm = T)) +
  ylim(0, max(c(tidy$Track_dist_m, tidy$Estimated_length_m), na.rm = T)) +
  coord_fixed() +
  theme_bw()
plot
```

## Reported species names
Which reported species names are named differently according to WoRMS, or could not be matched?
```{r}
i <- which(worms$Query != worms$valid_name)
print(worms[i,c("Query", "valid_name")])
```

Hierarchical dendrogram.
