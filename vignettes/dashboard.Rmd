---
title: "Database dashboard"
output: html_document
---

```{r}
library(TripleD)
```

The database contains `r length(unique(stations$StationID))` stations sampled during `r length(unique(stations$CruiseID))` cruises. The oldest sample was taken on `r min(stations$Date)` and the most recent sample was taken on `r max(stations$Date)`. Total suface area of the North Sea that has been sampled with the TripleD is ADD R CODE.

In total there are `r dim(species)[1]` biological entries from `r length(unique(species$Species_reported))` species. Nr of individuals. Total biomass.

# Stations
Map of all the sampled stations in the database. The North-Sea is bounded by the coordinates 62N to 50N, -5W to 10E.
```{r map, echo=FALSE, message=FALSE, warning=FALSE}
# NOAA bathymetry package
library(marmap)
# Geographic high-resolution outlines
library(mapdata)
# ggplot2 packing for visualizing map and datapoints
library(ggplot2)
# dplry package to easily search dataframes
library(dplyr)
# library with map projections
library(mapproj)

# The North-Sea is bounded by the coordinates 62N to 50N, -5W to 10E
#lats <- c(50, 62)
#lons <- c(-5, 10)
# map boundaries based on database values with a small buffer
lats <- c(min(stations$Lat_DD)-5, max(stations$Lat_DD)+5)
lons <- c(min(stations$Lon_DD)-5, max(stations$Lon_DD)+5)

# Download North-Sea Bathymetry data from NOAA
bathy <- getNOAA.bathy(
  lon1 = lons[1], lon2 = lons[2], lat1 = lats[1], lat2 = lats[2], 
  resolution = 1, keep = T)

# Convert to dataframe
bathy <- fortify.bathy(bathy)

# Get coastal outlines
reg = map_data("world2Hires")
reg <- reg %>%
  filter(
    long > lons[1] &
    long < lons[2] &
    lat > lats[1] &
    lat < lats[2])

# make plot
map_samples <- ggplot() +
  
  # add 20m contour
  geom_contour(data = bathy,
               aes(x = x, y = y, z = z),
               breaks = c(-20),
               size = c(0.3),
               colour = "grey") +
  
  # add 50m contour
  geom_contour(data = bathy, 
               aes(x = x, y = y, z = z),
               breaks = c(-50),
               size = c(0.3),
               colour ="grey") +
  
  # add 100m contour
  geom_contour(data = bathy, 
               aes(x = x, y = y, z = z),
               breaks = c(-100),
               size = c(0.3),
               colour = "grey") +
  
  # add coastline
  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               fill = "darkgrey", color = NA) + 
  
  # add points
  geom_point(data = stations, aes(x = Lon_DD, y = Lat_DD),
             fill = "red", colour = "black",
             size = 1, shape = 21) +
  
  # configure projection and plot domain
  coord_map(xlim = lons, ylim = lats) +
  
  # formatting
  ylab("")+xlab("")+
  theme_bw()
map_samples  
```

# Missing data
Percentage of entries that have a value for every attribute (higher percentage means better data coverage).
```{r stations, echo=FALSE}
stations_perc_complete <- stations %>%
  sapply(., 
    function(x){sum(length(which(!is.na(x))))/dim(stations)[1]}
  ) %>%
  sort(., decreasing = T) %>%
  as.data.frame() %>%
  as_tibble(rownames = "Attribute")
colnames(stations_perc_complete)[2] <- "Percentage"

stations_perc_complete$Attribute <- factor(
  stations_perc_complete$Attribute, levels = stations_perc_complete$Attribute)

perc_complete <- ggplot(stations_perc_complete) +
  geom_col(aes(x = Attribute, y = Percentage)) +
  labs(title = "Stations", y = "% complete i.e. not NA") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  )
perc_complete
```

```{r species, echo=FALSE}
species_perc_complete <- species %>%
  sapply(., 
    function(x){sum(length(which(!is.na(x))))/dim(species)[1]}
  ) %>%
  sort(., decreasing = T) %>%
  as.data.frame() %>%
  as_tibble(rownames = "Attribute")
colnames(species_perc_complete)[2] <- "Percentage"

species_perc_complete$Attribute <- factor(
  species_perc_complete$Attribute, levels = species_perc_complete$Attribute)

perc_complete <- ggplot(species_perc_complete) +
  geom_col(aes(x = Attribute, y = Percentage)) +
  labs(title = "Species", y = "% complete i.e. not NA") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  )
perc_complete
```

